<!DOCTYPE html>
{% extends "teams/base.html" %}
{% load static from staticfiles %}
{% load datetime_filter %}
<html lang="en">
  <head>
    {% block title %}Set - {{ team.abbr }}{% endblock %}
    {% block stylesheets %}
      <link rel="stylesheet" href="{% static 'teams/css/set_detail.css' %}">
    {% endblock %}
  </head>

  <body>
    {% block sidebar %}
      {{ block.super }}
    {% endblock %}

    {% block page-title %}{{ team.name }}{% endblock %}
    {% block table-title %}Set Details{% endblock %}

    {% block action-buttons %}
      <!-- Edit set -->
      <span data-toggle="modal" data-target="#editModal">
        <button type="button" class="btn btn-default btn-md pull-right" style="margin-left: 5px" data-toggle="popover" data-content="Edit" data-trigger="hover" data-placement="auto bottom">
          <span class="glyphicon glyphicon-pencil"></span>
        </button>
      </span>
      <!-- Delete set -->
      <a href="{% url 'teams:deleteSet' team.abbr set.id %}" type="button" class="btn btn-danger btn-md pull-right" style="margin-left: 5px" data-toggle="popover" data-content="Delete" data-trigger="hover" data-placement="auto bottom">
        <span class="glyphicon glyphicon-remove-circle"></span>
      </a>
      <!-- Finish editing set -->
      <a href="{% url 'teams:practiceSchedule' team.abbr week %}" type="button" class="btn btn-primary btn-md pull-right" style="margin-left: 5px" data-toggle="popover" data-content="Finish" data-trigger="hover" data-placement="auto bottom">
        <span class="glyphicon glyphicon-ok-circle"></span>
      </a>
    {% endblock %}

    {% block modal %}
      <div id="editModal" class="modal fade" role="dialog">
        <div class="modal-dialog">

          <!-- Modal content-->
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal">&times;</button>
              <h4 class="modal-title">
                Create a Set
              </h4>
            </div>

            <div class="modal-body">
              <form id="set_form" action="{% url 'teams:setDetail' team.abbr set.id %}" method="post">
                {% csrf_token %}
                {{ rep_formset.management_form }}

                <!-- Set form errors -->
                {% if set_form.errors %}
                  {% for field in set_form %}
                    {% for error in field.errors %}
                      <div class="alert alert-danger" style="text-align: center">
                          <strong>{{ error|escape }}</strong>
                      </div>
                    {% endfor %}
                  {% endfor %}
                  {% for error in set_form.non_field_errors %}
                    <div class="alert alert-danger" style="text-align: center">
                        <strong>{{ error|escape }}</strong>
                    </div>
                  {% endfor %}
                {% endif %}

                <!-- Set form -->
                {{ set_form.focus }}
                {{ set_form.repeats }}
                {{ set_form.order }}
                <div class="btn-group btn-group-justified" data-toggle="buttons">
                  {% for radio in set_form.pace %}
                    <label class="btn btn-default">
                      {{ radio.tag }}
                      {{ radio.choice_label }}
                    </label>
                  {% endfor %}
                </div>
                <hr>


                <!-- Rep form -->
                <table id="reps" border="0" cellpadding="0" cellspacing="0">
                    <tbody>
                        {% for form in rep_formset.forms %}
                        <tr>
                           <td>{{ form.num }}</td>
                           <td>{{ form.distance }}</td>
                           <td>{{ form.stroke }}</td>
                           <td>{{ form.rest }}</td>
                           <td>{{ form.comments }}</td>
                           <td class="remove"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <hr>

                <!-- Swimmer/Team select -->
                <div class="btn-group btn-group-justified" data-toggle="buttons">
                  {% for radio in set_form.group %}
                    <label id="group_btn_{{ forloop.counter }}" class="btn btn-default">
                      {{ radio.tag }}
                      {{ radio.choice_label }}
                    </label>
                  {% endfor %}
                </div>

                <div class="table-responsive swimmers" style="display: none">
                  <table class="table table-striped table-hover swimmers">
                    {% for checkbox in set_form.swimmers %}
                      <tr class="swimmer-checklist">
                        <td class="swimmer-checkbox">{{ checkbox.tag }}</td>
                        <td>{{ checkbox.choice_label }}</td>
                      </tr>
                    {% endfor %}
                  </table>
                </div>
                <br>

                <div class="modal-footer">
                  <button type="submit" name="set_create" class="btn btn-md btn-primary">Finish</button>
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
              </form>

            </div>

          </div>

        </div>
      </div>
    {% endblock %}

    {% block content %}
      <!-- Display sets & reps -->
      <div class="set">
        <h3>
          {{ set.order }})
          {{ set.focus|title }}
          {% if set.repeats %}
             - {{ set.repeats }}x
          {% endif %}
        </h3>

        <div class="col-xs-12 col-sm-4 set-components">
          {% for rep in set.rep_set.all reversed %}
            {{ rep.num }} x {{ rep.distance }} {{ rep.stroke }}
            {% if rep.rest %}
              @ {{ rep.rest|format_duration }} rest
            {% endif %}
            {% if rep.comments %}
              - {{ rep.comments|capfirst }}
            {% endif %}
            <br>
          {% endfor %}
        </div>

        <div class="col-xs-12 col-sm-8 set-components">
          <h5>Swimmers</h5>
          {% for swimmer in set.swimmers.all %}
            {{ swimmer.f_name }} {{ swimmer.l_name }}<br>
          {% endfor %}
        </div>

      </div>
    {% endblock %}

    {% block scripts %}
      <!-- Allow reps to be added or removed from set form -->
      <script type="text/javascript" src="{% static 'django-dynamic-formset/src/jquery.formset.js' %}"></script>
      <script>
        $(function() {
            $('#set_form #reps tbody tr').formset({
              addText: 'Add'
            });
        })
      </script>

      <!-- Disables 'remove' function when there is only one rep -->
      <script>
        $(function() {
          document.getElementsByClassName("remove")[0].style.display = "none";
          document.getElementsByClassName("add-row")[0].addEventListener("click", toggleRemove_onAdd);

          function toggleRemove_onAdd() {
            var row_count = $("#reps tr").length;
            if (row_count <= 2){
              document.getElementsByClassName("remove")[0].style.display = "none";
            } else {
              document.getElementsByClassName("remove")[0].style.display = "table-cell";
            }

            var delete_row = document.getElementsByClassName("delete-row")
            for (var i = 0; i < delete_row.length; i++) {
              delete_row[i].addEventListener("click", toggleRemove_onDelete);
            }
          }

          function toggleRemove_onDelete() {
            var row_count = $("#reps tr").length;
            if (row_count <= 2){
              document.getElementsByClassName("remove")[0].style.display = "none";
            } else {
              document.getElementsByClassName("remove")[0].style.display = "table-cell";
            }
          }
        });
      </script>

      <!-- Controls display property of swimmer list with click of button group -->
      <script>
        $(function() {
          $( "#group_btn_1" ).click(function() {
            $( ".swimmers" ).hide();
          });
          $( "#group_btn_2" ).click(function() {
            $( ".swimmers" ).show();
          });
        });
        $(function() {
          $( "#team" ).click(function() {
            $( "#team" ).addClass("active");
            $( "#individuals" ).removeClass("active");
            $( ".swimmers" ).hide();
          });
          $( "#individuals" ).click(function() {
            $( "#team" ).removeClass("active");
            $( "#individuals" ).addClass("active");
            $( ".swimmers" ).show();
          });
        });
      </script>

      <!-- Toggle checkbox when the table row is clicked -->
      <script>
      $(function() {
        var checkLists = document.getElementsByClassName("swimmer-checklist");
        function toggleCheck(a) {
          id_string = "#id_swimmers_" + a;
          cBox = $( id_string );
          cBox.prop("checked", !cBox.prop("checked"));
        }
        for ( var i = 0; i < checkLists.length; i++ ) {
          checkLists[i].onclick = (function(i) {
            return function() {
              toggleCheck(i);
            }
          })(i);
        }
      });
      </script>
    {% endblock %}
  </body>
</html>
